# 허브와 라우터

#### 허브

LAN 어댑터를 거쳐 디지털데이터 -> 전기신호가 된 신호는 이제 리피터 허브 -> 스위칭 허브 -> 라우터를 거쳐서 인터넷 접속용 라우터 -> 인터넷으로 나가게 됩니다.

##리피터허브

우선 패킷이 LAN어댑터에서 케이블로 나가게 됩니다. 여기서 케이블은 RJ-45커넥터를 통해 Twist Pair Cable입니다.  좀더 확대해보면

LAN어댑터의 PHY(physical layer device)(신호 송수신 회로) 회로 -> RJ-45커넥터 -> Twist Pair Cable의 구성입니다.

여기서 Twist Pair Cable은 흔히 말하는 여러 색의 8줄로 이루어진 랜선입니다.  그런데 이 케이블로 넘어간 신호는 허브를 향해 가는데 허브에 도착하면 신호가 약해져 있습니다. 각이 뭉개진다거나, 파형이 왜곡된다거나, 신호의 높이가 낮아지게 됩니다. 이러한 이유는 주파수가 높을수록 에너지가 떨어지는 비율이 높아지기 때문이니다.  즉 에너지에 손실이 발생하는 것입니다. 이럴경우 0과 1을 잘못판단할 수 있는데 이 경우 통신 오류가 됩니다. 

### 에너지 손실

에너지의 손실이 발생하는 이유는 전자파입니다. 전자파가 도전체(금속과 같은)에 닿으면 그 안에 전류가 발생하여 기존의 다른 전류에 뒤섞여 파형이 변동되는 것입니다. 케이블이 영향을 받는 전자파는 두 종류입니다.

첫째는 모니터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파입니다. 두번째는 같은 케이블 안의 인접한 신호선에서 누설되는 전자파입니다. 이는 신호라는 전류에 의해 전자파가 생기고 다른 신호선에 대한 잡음이 되는데 이를 크로스토크라고 합니다.

두가지 경우 모두 선을 꼬아서 해결할 수 있습니다. 전자는 신호선에 전자파가 닿으면 전자파의 진행방향의 오른쪽으로 전류가 생겨납니다. 그런데 신호선을 꼬아주면 나선형이되어 전류가 흐르는 반대 방향이 되게 됩니다. 그래서 잡음의 전류가 약해지게 됩니다. 후자의 경우 거리가 너무 가깝기 때문에 문제인데 신호선을 꼬는 간격을 미묘하게 모두 다르게 만들어 플러스와 마이너스를 바꿔서 잡음의 영향이 반대가 되게 만들어줍니다. 이러면 균형이 잡히면서 잡음의 영향이 줄어들게 됩니다.

또한 실드(피복)을 감싸거나 신호선 사이에 구분판을 넣어 잡음을 줄이는것도 방법입니다. 그걸 카테고리라는 척도로 성능을 나타냅니다.

### 전체에 송신

리피터 허브에 도착하게 되면 이더넷의 원리에 따라 접속해있는 모든 LAN전체에 신호가 흩어집니다. 거기서 MAC주소에 해당하는 기기가 그 패킷을 낚아채게 됩니다. 이러한 이더넷의 원리를 그대로 실현한 것이 리피터 허브입니다. 

이 리피터 허브에 들어와 리피터 허브의 PHY회로의 수신부로 도달하면 여기서부터는 리피터 회로에 들어가게 됩니다. 리피터회로는 들어오는 신호를 리피터 허브의 커넥터 부분에 뿌리게 됩니다. 다시말해 커넥터에 송출하는 것입니다.이후 신호는 모든 커넥터를 걸치며 MAC주소가 일치하는 곳으로 가게 됩니다. 혹시 잡음의 영향으로 파형이 변화되었어도 여기에서는 검사하지 않으며 다음기기인 스위칭 허브, 라우터, 서버 등 까지는 도달하게 됩니다. 이 곳에서 FCS(Frame Check Sequence)를 검사하게 됩니다.

## 스위칭 허브

스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 가도록 합니다. 스위치의 내부에는 MAC주소와 포트번호를 가진 라우팅테이블(경로표)이 있습니다. 리피터 허브를 통해 넘어온 데이터는 허브의 (RJ-45 -> PHY -> MAC -> 메모리) -> 스위치 회로를 거칩니다. 괄호를 친 부분은 다른 LAN 어댑터와 일치하는 부분입니다.

스위칭 허브의 포트도 일반 PC의 포트와 같은 부분입니다. 커넥터와 회로가 만나는 부분입니다. 다만 스위칭허브는 MAC주소를 검사하지 않기 때문에 MAC주소가 할당이 되어있지 않습니다. 즉 포트자체에 MAC주소는 없습니다. 

이제 수신처 mac주소를 확인하여 허브에 물려있는 다른 포트로 보내게 됩니다. 이 때 라우팅 테이블을 사용하게 됩니다. 허브에 물린 포트로 신호가 넘어가게 됩니다.이제 역방향으로 다른 포트의 메모리 MAC PHY RJ-45를 모두 거쳐 커넥터를 타고 라우터로 가게 됩니다.

스위치 허브가 가진 MAC 라우팅 테이블의 경우  패킷을 수신했을 때 송신처 MAC주소가 없다면 새로 등록해버립니다. 그리고 난뒤 일정 시간이 지나면 폐기합니다. 따라서 새로운 통신이 발생해도 등록되고 오래되면 없어지기 때문에 수동으로 등록 및 삭제의 필요가 없습니다.	

이러한 동작 도중에 다른 포트는 빈상태가 됩니다. MAC주소를 스위칭허브가 판단하여 송신하기 때문에 다른 포트는 놀고 있습니다. 따라서 여기에 복수의 동작이 가능하여 여러개의 패킷을 중계할 수 있습니다. 리피터허브의 경우 브로드캐스팅처럼 동시에뿌리기때문에 복수 중계가 불가능합니다.

## 라우터

리피터허브나 스위칭허브를 경유한 패킷은 라우터로 가게되고 이 라우터에서는 다음 라우터의 주소를 알려줄 것입니다. 그럼 또다시 리피터허브, 스위칭허브, 라우터를 걸쳐 결국서버까지 도달하게 되는 것입니다. 스위칭 허브와 비슷하지만 좀 다릅니다. 라우터의 바탕은 IP이며 허브의 바탕은 이더넷(MAC)이기 때문입니다.

라우터는 크게 중계부분과 포트부분으로 구성됩니다. 중계 부분은 판단하고 포트부분이 송수신을 담당합니다. 프로토콜 스택의 IP담당과 LAN어댑터의 역할이라고 생각하면 됩니다. 무선LAN의 경우에도 라우터의 포트부분에 무선 LAN용 하드웨어를 연결하는 것입니다. 라우터의 경우 ADSL이나 FTTH등의 광대역 회선과 전용선을 지원하기도 합니다.

스위칭 허브와의 가장 큰 차이점은 라우터는 포트부분에서 송수신을 모두하지만 스위칭 허브는 들어온 패킷을 전송만하고 자신이 송신처나 수신처가 되지는 않습니다.

### 라우팅 테이블

스위칭허브는 MAC주소로 중계대상을 판단하지만 라우터는 IP주소로 중계 대상을 판단합니다. 

라우팅테이블에는 조금씩 다르지만 보통의 경우 수신처, 넷마스크, 게이트웨이, 인터페이스, 메트릭의 내용을 담습니다. 여기서 인터페이스는 포트와 동일합니다. 메트릭은 수신처에 기록되어있는 목적지와의 거리를 나타냅니다. 수가 작으면 가까이 있고 멀 수록 멀리있습니다.

경로표에 경로정보를 등록하는 과정도 스위칭 허브와는 다릅니다. 스위칭 허브는 등록, 삭제 수정의 과정이 따로 필요하지 않았습니다. 그런데 라우터의 경우 사람이 수동으로 경로정보를 등록/갱신하거나 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로정보를 교환하고 라우터가 자체에서 경로표를 등록하게 됩니다. 이 때 사용하는 프로토콜은 RIP, OSPF, BGP등 다양합니다.

### 패킷수신동작

라우터의 동작을 추적해보겠습니다. 우선 수신부분입니다. 이더넷의 경우만 알아봅시다.

신호가 커넥터에 도착하면 역시 PHY 회로와 MAC회로에서 디지털 데이터로 변환과정을 거칩니다. FCS로 오류의 유무를 검사하고 그 뒤 MAC주소의 수신처가 자신의 주소와 일치하는지를 조사한 뒤 버퍼메모리에 저장하게 됩니다. 

수신동작이 끝나면 맨 앞의 MAC헤더를 폐기합니다. 그런 뒤 IP헤더의 내용을 보고 패킷 중계동작에 들어갑니다. 자신의 라우팅 테이블과 패킷의 헤더의 IP 수신처를 대조합니다. 전부 같지는 않아도 되며 넷마스크 항목에 등록된 값에서 네트워크 번호의 비트수를 판단하여 네트워크 부분만 비교합니다.(IP주소는 네트워크번호 + 넷마스크)

혹시 대조 후 같은 행이 없다면 패킷을 폐기하고 ICMP(internet control message protocol) 메시지로 송신처에 통보하게 됩니다.

하지만 넷마스크가 0.0.0.0인 경우 이것은 모든 주소에 일치하기 때문에 해당하는 경로가 없다면 이리로 오게 됩니다. 그 경우 게이트웨이 항목에 값을 넣어 그곳으로 보내게 되고 그걸 기본 게이트웨이 라고 합니다.

### 유효기간

중계대상을 찾은 라우터는 패킷을 출력하기 전에 몇가지 단계를 거칩니다. 우선 TTL(Time to Live)이라는 IP헤더 필드를 갱신하게 됩니다. 이 항목은 생존기간을 나타내는데 라우터를 거칠때마다 1씩 줄어들며 0이되면 패킷을 폐기합니다. 이 이유는 경로표가 잘못되어 라우터를 뺑뺑 돌게되면 폐기시키기 위함입니다.





성공과 실패를 결정하는 1%의 네트워크원리, Tcutomu Tone, 이도희 옮김, 성안당