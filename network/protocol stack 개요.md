# 프로토콜 스택 개요

## 데이터 송수신 개요

DNS서버와의 통신을 통해 IP주소를 알아냈으면 이제 OS의 프로토콜 스택에 의뢰해서 메시지를 송신해야 합니다. DNS서버와의 통신처럼 소켓을 이용합니다. DNS서버의 경우 소켓 라이브러리의 리졸버를 이용했지만 여기서는 좀 다릅니다.

우선 데이터를 송수신하는 컴퓨터 사이에는 데이터의 통로(이하 파이프)가 있습니다. 이 파이프에 데이터를 흘려보낸다고 생각하면 됩니다.

클라이언트 <====파이프====> 서버와 같은 구조입니다. 그런데 이 파이프는 최초부터 존재하는 것은 아니며 송 수신 동작을 하기 전에 서로 연결해주어야 합니다. 이 파이프의 양 끝에 있는 데이터의 출입구가 바로 소켓입니다. 서버의 경우 소켓을 만들어 기다리고 있으며 이 소켓에 클라이언트가  소켓 라이브러리로 출입구를 만들어 연결하면 통신이 가능해지는 것입니다. 통신 종료의 경우 어느쪽에서든 먼저 분리하면 되지만 보통은 서버측에서 분리합니다.(HTTP) 즉 정리해보자면

1. 소켓을 만듭니다
2. 소켓을 파이프에 연결합니다.
3. 데이터를 보내고 받습니다.
4. 파이프를 분리해 소켓을 말소합니다.

이 네가지 동작을 실행한튼 것이 바로 OS의 프로토콜 스택입니다. 애플리케이션 층(예를들어 브라우저)에서 URL을 통해 IP를 조회한 후 프로토콜 스택에게 요청하여 다음과 같은 4단계를 거쳐 통신하게 되는 것입니다. 이에 소켓 라이브러리의 프로그램을 호출하지만 호출된 프로그램은 단지 프로토콜 스택에 요청만 할 뿐 실질적인 작업은 하지 않습니다.

```
<변수> = gethostbyname("www.xxxx.yyy.com"); // ip주소 조회

<디스크립터> = socket(<조회한 ip>, <스트림>, <TCP사용>, ... ); // #1

connect(<디스크립터>, <서버의 IP주소와 포트번호>, ...); // #2

write(<디스크립터>, <송신 데이터>, <데이터 길이>); // #3

<수신 데이터> = read(<디스크립터>, <수신 버퍼>, ...); // #4

close(<디스크립터>); // 연결종료
```

애플리케이션 레이어에서는 다음과 같은 동작들이 발생하게 됩니다. 

여기서는 각각의 단계에 대해 간단하게만 설명하고 한 부분씩 다른 파일에 나누어 설명하겠습니다.

우선 #1번에서 우변을 보면 소켓을 만듭니다. IP와 여러 설정을 입력하면 디스크립터를 반환받습니다.이 디스크립터는 소켓을 식별하기 위한 식별자입니다. 한 컴퓨터 내부에서 송 수신 동작 여러개가 같이 돌아간다면 복수의 소켓을 구분할 구분자가 필요한데 이게 디스크립터입니다.

다음으로 #2번의 경우 connect를 호출합니다. 이 때 디스크립터, 서버 IP주소, 포트번호가 가장 요점입니다. connect는 서버와 연결하는 동작입니다. 서버와 우선 통신을 하겠다고 서로 인사(커넥트)를 나눈 뒤 명함(메시지)을 주고받는 게 통신입니다. 이 때 디스크립터를 이용하여 여러 소켓중에 어느것을 서버의 소켓에 접속할지 알게 됩니다. IP주소는 어느 서버에 접속할지 알게되는 것이기 때문에 중요합니다. 그런데 IP주소의 경우 서버의 어느 컴퓨터인가까지만 알게됩니다. 통신은 파이프기때문에 서로의 소켓을 파이프로 연결한다고 위에서 얘기했습니다. IP주소를 들고 컴퓨터까지는 갈 수 있지만 그 컴퓨터의 어느 소켓인지는 정보가 없습니다. 이 때 필요한 정보가 바로 포트입니다. 디스크립터를 사용하면 소켓을 지정할 수 있다고 생각할 수 도 있지만 디스크립터는 소켓을 만든 애플리케이션(브라우저)에게만 거네주지 접속상대는 그 값을 모릅니다. 따라서 접속 상대측에서는 그 값을 모릅니다. 그렇기에 포트번호를 사용합니다. 즉 접속 상대측에서 소켓을 지정하기 위해 사용하는 것이 포트번호입니다.

다음으로 #3에서는 메시지를 주고 받습니다. write를 호출하여 실제로 데이터를 넘기는 작업을 합니다. 이 때 송신 데이터를 애플리케이션이 메모리에 준비를 합니다. 그리고 난뒤 데이터를 모두 쏟아 부어 넘깁니다. 그 뒤 read로 응답을 수신합니다. 이 때의 메모리 영역을 수신버퍼라고 합니다.

마지막으로 #4에서는 close를 호출하여 연결을 끊습니다. 웹에서는 보통 서버측에서 먼저 끊기 동작을 실행하고, 이를 전달받아 클라이언트도 끊습니다.

#### 참고자료

성공과 실패를 결정하는 1%의 네트워크원리, Tcutomu Tone, 이도희 옮김, 성안당