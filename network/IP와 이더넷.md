# IP와 이더넷

## 선행 지식

### 패킷의 기본

패킷은 기본적으로 헤더 + 데이터로 구성 되어있다. IP 담당 부분을 지나 LAN을 타고 패킷은 중계장치로 넘어간다. 이 중계장치에는 라우터와 허브가 있다. 이 중계장치들에는 수신처가 어느 방향으로 가야한다는 표가 있다. 이 표를 경로표 혹은 라우팅 테이블이라고 한다.

서브넷은 기본적으로 허브와 각각의 기기들이 연결되어있고 이 서브넷을 연결하는 것이 라우터다. 즉 서브넷 - 라우터 - 서브넷의 구조다. 그래서 라우터를 통해 다른 서브넷으로 갈 수 있다. 라우터에 있는 경로표와 수신처를 비교해서 다음 라우터를 찾아 넘어가면 서브넷을 이동하게 된다.

라우터와 서브넷 사이에는 허브가 있다. 즉 (허브 -> 라우터)(서브넷1) -> (허브 -> 라우터)(서브넷2)의 형태를 가진다. 이 허브는 라우터까지 운반해주는 역할을 한다. 라우터는 다음 라우터를 검색하고 그 사이에 허브가 껴있어서 허브가 라우터까지 데려다주는 방식이다.

* 라우터 : 목적지를 확인하여 다음 라우터를 알려준다. IP가 목적지를 확인하여 다음 IP중계장치를 나타낸다. IP 헤더를 사용한다.
* 허브 : 허브가 서브넷 안에서 퍀킷을 운반하여 다음 라우터까지 운반한다. 서브넷 안에 있는 이더넷이 중계장치까지 패킷을 운반한다. MAC헤더를 사용한다.

IP헤더와 MAC헤더 중 IP헤더는 수신처의 목적지다. 즉 서버의 주소를 가진다. MAC헤더는 바로 다음 라우터다. 그래서 계속 바뀐다. 

정리하자면 IP담당을 거쳐 LAN선을 탄 패킷은 클라이언트 -> 허브 -> 라우터 -> 허브 -> 라우터 -> 허브 .... 의 과정으로 도착하게 된다.

## IP 담당

IP담당 부분은  사실 크게 하는일은 없다. 이미 TCP에서 많은 일을 거친 패킷은 IP담당으로 넘어오게 된다. 그럼 IP담당에선느 IP헤더와 MAC헤더를 붙인다.

* IP 헤더 : IP주소로 표싣된 목적지 까지의 주소의 제어정보를 기록
* MAC 헤더: 이더넷 등 LAN을 사용하여 가장 가까운 라우터까지 패킷을 운반할 때 사용하는 제어 정보를 기록

이 차이가 있다. 선행지식이 있다면 라우터의 개념이 눈에 들어올 것이다. 이게 IP담당의 역할이다.

이를 이제 네트워크용 하드웨어(이더넷, 무선 LAN 등)에게 전달하면 디지털 데이터가 전기나 빛 신호로 변경되게 된다. 이 하드웨어들이 하는 역할은 이게 거의 다다.

### IP헤더

IP헤더에는 버전, 헤더 길이, 생존기간, 프로토콜 번호(TCP, UDP, ICMP...), 송신처 IP주소, 수신처 IP주소와 같은 것들이 기록된다.그런데 딱히 하는 역할은 없고 TCP에서 넘겨준 IP주소를 그대로 기록하게 된다. 그런데 송신처 IP주소는 LAN어댑터가 하나라면 주소가 하나겠지만 복수의 경우는 조금 복잡하다.

송신처가 복수의 IP주소를 가지고 있다면 어느 것을 하나 정해야 합니다. 이 경우 라우터가 경로표를 사용하는것과 같은 동작을 하게 됩니다. 이 경로표를 사용해서 주소를 정하는 것은 다음에 다시 정리하겠습니다. 경로표의 예로는 cmd에 route print를 치면 나옵니다.

참고로 경로표의 게이트웨이가 나오는데 TCP/IP 에서 게이트웨이는 라우터와 같습니다.

### MAC헤더

IP헤더 앞에 MAC헤더를 붙입니다. 이는 이더넷용으로 사용합니다. 다음 라우터의 주소를 MAC의 수신처에 기록합니다.

이더넷은 TCP/IP와는 다른 구조로 패킷의 수신처를 판단하는데 이것이 MAC입니다. MAC헤더에는 수신처, 송신처, 이더타입이 세가지만 존재합니다. MAC주소는 48비트로 통으로 주소입니다. 이더타입은 이더타입까지가 MAC헤더이고 그 뒤로는 다른 내용이라는 경계선을 알려줍니다. 보통 0800(IP프로토콜), 0806(ARP프로토콜)이 제일 많이 사용됩니다.

송신처주소를 기입하는것은 쉬우며, 수신처주소는 조금 복잡합니다. 수신처주소는 IP주소와는 다르기때문에 모릅니다. 어디로 가야하는지 알 수 가 없는 상태입니다. 그래서 이걸 경로표에서 찾게됩니다. 경로표의 gateway(라우터) 항목의 주소가 상대측이 됩니다. 근데 이건 IP주소입니다. 경로표에는 IP주소만 적혀있기 때문에 MAC주소를 알아내야 합니다.

여기에서 사용되는 것이 ARP입니다. Address Resoulution Protocol인데 개념은 간단합니다. 이더넷에 연결된 모든 기기에게 패킷을 전달하는 개념이 브로드 캐스트라고 합니다. 이 브로드캐스트 기능을 사용하여 자신과 연결된 다른 모든 기기들에게 방금 알아낸 IP주소를 건네주고 이 IP주소에 딸린 MAC주소를 아는 곳을 찾는다고 메시지를 돌리는 것입니다. 그러면 일치하는 곳에서 MAC주소를 받게된다. 근데 항상물어보면 귀찮으니 ARP캐시를 사용합니다.

## 이더넷

이더넷은 예전에 중고등학교에서 배운 통신방법입니다. 케이블로 네트워크를 구성하고 이 이더넷에 신호를 보내 통신하는 방식입니다.  초창기 형태의 이더넷은 서로 같은 케이블로 모두 연결되어있고 a라는 통신상대를 찾는다고 모든 기기에게 외치고 맞는 기기가 패킷을 낚아채는 방식이었습니다. 그 뒤로 토큰링, 허브사용, 별형, 버스형 뭐 이런게 있습니다.

여러 변화가 있었지만 결국 MAC헤더의 수신처 주소로 상대방에게 패킷을 찾고, 송신처와 이더타입을 기입하여 헤더를 만든다는 성질은 변하지 않았습니다.

이 이더넷의 송수신 동작은 디지털 데이터를 전기나 빛 신호로 변환한다는 것이 중요합니다. 이는 LAN어댑터에서 하는 역할입니다. LAN어뎁터가 드라이버 소프트웨어를 통해 이 신호 변화를 담당합니다.

전기신호가 된 패킷은 MAC회로를 통해 프리앰블, 스타트프레임 딜리미터라는 데이터를 앞에 붙이고, 프레임 체크 시퀀스(FCS)라는 데이터를 맨 뒤에 붙이게 됩니다. 프리앰블은 송신에 있어 타이밍을 잡기 위한것입니다. 스타트 프레임 딜리미터도 비슷한데 패턴을 다르게 주어 패킷의 시작점을 나타냅니다. FCS는 중간에 파형이 흐트려져 데이터가 변한경우 이를 검출하기 위해 사용합니다.

#### 참고자료

성공과 실패를 결정하는 1%의 네트워크원리, Tcutomu Tone, 이도희 옮김, 성안당